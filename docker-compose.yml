services:
  api:
    build:
      context: .
      dockerfile: .docker/backend/Dockerfile
      target: dev
    working_dir: /var/www
    volumes:
      - ./backend:/var/www
    ports:
      - "8080:8080"
      - "14550:14550/udp"
    environment:
      GOTOOLCHAIN: "auto"
      DATABASE_URL: "postgres://app:secret@db:5432/appdb?sslmode=disable"
      UPLOAD_DIR: "/var/www/uploads"
      MQTT_UUID: "2f37308d-ccf8-4685-8329-c164599259ca"
    depends_on:
      db:
        condition: service_healthy

  web:
    build:
      context: .
      dockerfile: .docker/frontend/Dockerfile
      target: dev
    working_dir: /var/www
    volumes:
      - ./frontend:/var/www
      - node_modules_cache:/var/www/node_modules
    ports: ["5173:5173"]
    environment:
      VITE_GOOGLE_MAPS_KEY: "AIzaSyCO7jmmpwFItFAlf-v2VVjKpLAmfBSEO8k"
      VITE_API_BASE: "http://localhost:8080"
      VITE_API_BASE_WS: "ws://localhost:8080"
      MQTT_UUID: "2f37308d-ccf8-4685-8329-c164599259ca"
    command: >
      sh -lc "yarn install --frozen-lockfile &&
              yarn dev --host 0.0.0.0"

  db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=appdb
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d appdb"]
      interval: 2s
      timeout: 2s
      retries: 20

volumes:
  node_modules_cache:
  pgdata:

